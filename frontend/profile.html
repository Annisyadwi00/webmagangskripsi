<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Profil Akun â€¢ Portal Magang UNSIKA</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>
    .profile-wrapper {
      min-height: 100vh;
      background: var(--bg-main);
    }
    .profile-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: var(--shadow-soft);
      padding: 22px 22px 18px;
      max-width: 780px;
      margin: 24px auto;
      border: 1px solid var(--border-soft);
    }
    .section-title {
      margin: 0 0 6px;
      font-size: 20px;
      font-weight: 650;
    }
    .section-subtitle {
      margin: 0 0 20px;
      color: var(--text-muted);
      font-size: 13px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px 16px;
    }
    .profile-actions {
      margin-top: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .badge-muted {
      background: #f3f4f6;
      color: var(--text-muted);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
    }
    .alert-box {
      padding: 10px 12px;
      border-radius: 12px;
      background: #ecfdf3;
      border: 1px solid #bbf7d0;
      color: #166534;
      font-size: 13px;
      display: none;
      margin-top: 10px;
    }
    .alert-error {
      background: #fef2f2;
      border-color: #fecaca;
      color: #b91c1c;
    }
  </style>
</head>
<body class="profile-wrapper" onload="initProfile()">
  <div class="dashboard-shell">
    <header class="topbar">
      <div class="brand">
        <span class="brand-title">Portal Magang UNSIKA</span>
        <span class="brand-sub">Profil Akun</span>
      </div>
      <div class="user-menu">
        <span class="badge-muted" id="userRole">-</span>
        <div class="avatar-circle" id="avatarInitial">U</div>
        <span id="userName">Pengguna</span>
        <button class="btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <main class="dashboard-content">
      <div class="profile-card">
        <h2 class="section-title">Data Profil</h2>
        <p class="section-subtitle">Perbarui nama, email, atau password akun Anda.</p>

        <form onsubmit="updateProfile(event)">
          <div class="form-grid">
            <div class="form-group">
              <label>Nama Lengkap</label>
              <input type="text" id="name" placeholder="Nama sesuai akun" />
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="email" placeholder="nama@student.unsika.ac.id" />
            </div>
            <div class="form-group">
              <label>Password Baru (opsional)</label>
              <input type="password" id="password" placeholder="Kosongkan jika tidak ingin ubah" />
            </div>
            <div class="form-group">
              <label>Peran</label>
              <input type="text" id="role" disabled />
            </div>
          </div>

          <div class="profile-actions">
            <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
            <span class="alert-box" id="successBox">Profil berhasil diperbarui.</span>
            <span class="alert-box alert-error" id="errorBox"></span>
          </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    const apiBase = "http://localhost:3000/api/v1";
    let token = "";

    function logout() {
      localStorage.clear();
      location.href = "login.html";
    }

    function fillUserMenu(name, role) {
      const initial = name?.charAt(0)?.toUpperCase() || "U";
      document.getElementById("userName").textContent = name || "Pengguna";
      document.getElementById("userRole").textContent = role || "-";
      document.getElementById("avatarInitial").textContent = initial;
    }

    async function initProfile() {
      token = localStorage.getItem("token");
      const cachedName = localStorage.getItem("name");
      const cachedRole = localStorage.getItem("role");

      if (!token) {
        alert("Silakan login kembali untuk membuka profil.");
        location.href = "login.html";
        return;
      }

      fillUserMenu(cachedName, cachedRole);
      await loadProfile();
    }

    async function loadProfile() {
      hideAlerts();
      try {
        const res = await fetch(`${apiBase}/profile`, {
          headers: { Authorization: "Bearer " + token },
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.msg || data.error || "Gagal memuat profil.");
        }

        document.getElementById("name").value = data.name || "";
        document.getElementById("email").value = data.email || "";
        document.getElementById("role").value = data.role || "";
        fillUserMenu(data.name, data.role);
      } catch (err) {
        showError(err.message);
      }
    }

    async function updateProfile(event) {
      event.preventDefault();
      hideAlerts();

      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      const payload = {};
      if (name) payload.name = name;
      if (email) payload.email = email;
      if (password) payload.password = password;

      if (Object.keys(payload).length === 0) {
        showError("Isi setidaknya satu kolom untuk diperbarui.");
        return;
      }

      try {
        const res = await fetch(`${apiBase}/profile`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.msg || data.error || "Gagal memperbarui profil.");
        }

        document.getElementById("password").value = "";
        document.getElementById("name").value = data.name || "";
        document.getElementById("email").value = data.email || "";
        fillUserMenu(data.name, data.role);

        localStorage.setItem("name", data.name || "");
        localStorage.setItem("email", data.email || "");
        showSuccess();
      } catch (err) {
        showError(err.message);
      }
    }

    function showSuccess() {
      const box = document.getElementById("successBox");
      box.style.display = "inline-flex";
    }

    function showError(msg) {
      const box = document.getElementById("errorBox");
      box.textContent = msg;
      box.style.display = "inline-flex";
    }

    function hideAlerts() {
      document.getElementById("successBox").style.display = "none";
      document.getElementById("errorBox").style.display = "none";
    }
  </script>
</body>
</html>