<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Mahasiswa ‚Äì Portal Magang</title>
  <link rel="stylesheet" href="assets/css/styles.css" />

  <style>
    .notif-box {
      background: var(--primary-soft);
      border-left: 4px solid var(--primary);
      padding: 14px 18px;
      border-radius: 14px;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }
    .notif-success {
      border-color: #16a34a;
      background: #d1fae5;
    }
    .notif-error {
      border-color: #dc2626;
      background: #fee2e2;
    }
    .notif-info {
      border-color: #0284c7;
      background: #e0f2fe;
    }
  </style>
</head>

<body onload="initPage()">
  <div class="dashboard-shell">

    <!-- TOPBAR -->
    <header class="topbar">
      <div class="brand brand-with-nav">
        <div class="brand-mark">
          <div class="brand-logo">F</div>
          <div>
            <span class="brand-title">FASILKOM UNSIKA</span>
            <span class="brand-sub">Portal Magang</span>
          </div>
        </div>
        <nav class="topnav">
          <a href="#homeSection">Home</a>
          <a href="#infoSection">About Us</a>
          <a href="#lowonganList">Lowongan</a>
        </nav>
      </div>

      <div class="user-menu">
        <a class="link-muted" href="profile.html">Profil</a>
        <span id="userName">Mahasiswa</span>
        <div class="avatar-circle" id="userInitial">M</div>
        <button class="btn btn-ghost" onclick="logout()">Keluar</button>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="dashboard-content">
       <!-- HERO / HOME SECTION -->
      <section class="hero-card" id="homeSection" style="display:none;">
        <div class="hero-left">
          <p class="pill">Selamat datang</p>
          <h1 id="heroTitle" style="margin:6px 0 10px;">Dashboard Mahasiswa</h1>
          <p id="heroSubtitle" style="max-width:520px;color:var(--text-muted);">
            Kelola pengajuan, pantau progres logbook, dan cek status bimbingan dalam satu tempat.
          </p>
          <div class="hero-actions" style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="goPengajuan()">Ajukan magang sekarang</button>
            <a class="btn btn-ghost" href="logbook-mahasiswa.html">Isi logbook</a>
            <a class="btn btn-ghost" href="profile.html">Perbarui profil</a>
          </div>
        </div>
        <div class="hero-right">
          <div class="stat-chip">
            <span class="chip-label">Status pengajuan</span>
            <strong id="chipPengajuan">-</strong>
          </div>
          <div class="stat-chip">
            <span class="chip-label">Progress logbook</span>
            <strong id="chipLogbook">0 entri</strong>
          </div>
          <div class="stat-chip">
            <span class="chip-label">Jadwal bimbingan</span>
            <strong id="chipBimbingan">Belum dijadwalkan</strong>
          </div>
        </div>
      </section>

      <!-- NOTIFIKASI -->
      <div id="notifBox" class="notif-box"></div>

       <!-- STRIP INFO UTAMA -->
      <section class="strip-grid" id="infoSection">
        <article class="strip-card highlight">
          <div class="strip-head">
            <div class="strip-icon">üó∫Ô∏è</div>
            <div>
              <p class="strip-label">Lowongan aktif</p>
              <h3>Daftar Lowongan</h3>
            </div>
          </div>
          <p id="stripLowonganText" class="strip-desc">Memuat lokasi lowongan terbaru...</p>
          <div class="strip-actions">
            <span id="stripLowonganMeta" class="pill-soft">-</span>
            <a href="#lowonganList" class="btn btn-ghost">Lihat lowongan</a>
          </div>
        </article>
        <article class="strip-card">
          <div class="strip-head">
            <div class="strip-icon">üë©‚Äçüè´</div>
            <div>
              <p class="strip-label">Bimbingan</p>
              <h3>Daftar Dosen</h3>
            </div>
          </div>
          <p class="strip-desc">Kenali dosen pembimbing yang bisa diajak konsultasi dan pantau ketersediaannya.</p>
          <div class="strip-actions">
            <span class="pill-soft">Hubungi prodi</span>
            <a href="status-pengajuan.html" class="btn btn-ghost">Cek penugasan</a>
          </div>
        </article>
        <article class="strip-card">
          <div class="strip-head">
            <div class="strip-icon">‚ÑπÔ∏è</div>
            <div>
              <p class="strip-label">Informasi</p>
              <h3>Konversi & aturan</h3>
            </div>
          </div>
          <p class="strip-desc">Informasi singkat apakah magangmu terkonversi ke SKS, syarat laporan, dan tenggat penting.</p>
          <div class="strip-actions">
            <span class="pill-soft">Panduan prodi</span>
            <a href="upload-laporan.html" class="btn btn-ghost">Unggah berkas</a>
          </div>
        </article>
      </section>

      <div class="page-heading" id="lowonganList">
        <div>
          <h1>Lowongan Magang</h1>
          <p>Daftar langsung ke website resmi perusahaan.</p>
        </div>

        <button class="btn btn-primary" onclick="goPengajuan()">
          Ajukan Magang
        </button>
      </div>

      <div id="jobsContainer" class="cards-grid"></div>

      <p id="emptyState"
         style="margin-top:18px;font-size:13px;color:var(--text-muted);display:none;">
        Belum ada lowongan.
      </p>

    </main>
  </div>

<script type="module">
import { apiRequest } from "./src/apiService.js";
import { logout as doLogout, requireAuth } from "./src/auth.js";

const auth = requireAuth(["mahasiswa"]);

function initPage() {
  if (!auth) return;

  const name = auth.name || "Mahasiswa";
  document.getElementById("userName").innerText = name;
  document.getElementById("userInitial").innerText = name.charAt(0).toUpperCase();
  
  document.getElementById("heroTitle").innerText = `Hai, ${name}!`;
  document.getElementById("homeSection").style.display = "grid";

  // fallback stat default
  document.getElementById("chipLogbook").innerText =
    `${localStorage.getItem("logbookCount") || 0} entri`;
  document.getElementById("chipBimbingan").innerText =
    localStorage.getItem("jadwalBimbingan") || "Belum dijadwalkan";
  
    checkNotifikasi();
  loadJobs();
}

function logout() {
  doLogout();
}

function goPengajuan() {
  location.href = "pengajuan.html";
}

/* ============================
   NOTIFIKASI STATUS
============================ */
async function checkNotifikasi() {
  const notifBox = document.getElementById("notifBox");
  const email = auth?.email;

  try {
    const data = await apiRequest("/pengajuan");
    if(!Array.isArray(data)) return;
    // cari pengajuan milik mahasiswa
    const my = data.find(p => p.email === email);

    if (!my) return;

    document.getElementById("chipPengajuan").innerText = my.status || "-";

    // NOTIF berdasarkan status:
    if (my.status === "pending") {
      notifBox.classList.add("notif-info");
      notifBox.innerHTML = "Pengajuan kamu sedang dalam proses.";
      notifBox.style.display = "block";
    }
    else if (my.status === "disetujui") {
      notifBox.classList.add("notif-success");
      notifBox.innerHTML = "Pengajuan magang kamu telah <strong>disetujui!</strong>";
      notifBox.style.display = "block";
    }
    else if (my.status === "ditolak") {
      notifBox.classList.add("notif-error");
      notifBox.innerHTML = "Pengajuan magang kamu <strong>ditolak.</strong>";
      notifBox.style.display = "block";
    }

    // CEK apakah nilai sudah keluar
   const nilaiRes = await apiRequest(`/nilai/${my.id}`).catch(() => null);
    if (nilaiRes) {
      notifBox.classList.add("notif-success");
      notifBox.innerHTML = "Nilai akhir magang kamu sudah tersedia! üéâ";
      notifBox.style.display = "block";
    }

  } catch (err) {
    console.error(err);
  }
}


/* ============================
   LOAD LOWONGAN
============================ */
async function loadJobs() {
  const container = document.getElementById("jobsContainer");
  const emptyState = document.getElementById("emptyState");
  const stripText = document.getElementById("stripLowonganText");
  const stripMeta = document.getElementById("stripLowonganMeta");
  container.innerHTML = "<p style='font-size:13px;color:var(--text-muted);'>Memuat lowongan...</p>";
  emptyState.style.display = "none";

  try {
    const jobs = await apiRequest("/jobs");

    if (!Array.isArray(jobs) || jobs.length === 0) {
      container.innerHTML = "";
      emptyState.style.display = "block";
      if (stripText) stripText.innerText = "Belum ada lowongan aktif hari ini.";
      if (stripMeta) stripMeta.innerText = "0 posisi";
      return;
    }
    
    const uniqueLocations = [...new Set(jobs.map(job => job.location))];
    const lokasi = uniqueLocations.slice(0, 3).join(", ");
    if (stripText) {
      stripText.innerText = lokasi
        ? `Lowongan tersedia di ${lokasi}.`
        : "Lowongan terbaru siap dilamar.";
    }
    if (stripMeta) stripMeta.innerText = `${jobs.length} posisi aktif`;

    container.innerHTML = jobs.map(job => `
      <article class="job-card">
        <div class="job-company">${job.company}</div>
        <div class="job-title">${job.title}</div>

        <div style="font-size:13px;margin-top:4px;">
          ${job.description.substring(0,110)}...
        </div>

        <div class="job-meta">
          <span>${job.location}</span>
          <span style="font-size:11px;color:var(--text-muted);">
            ${new Date(job.createdAt).toLocaleDateString("id-ID")}
          </span>
        </div>

        <div class="job-actions">
          <span class="badge-pill">Sumber eksternal</span>
          <button class="btn btn-primary" onclick="daftar('${job.link}')">
            Daftar
          </button>
        </div>
      </article>
    `).join("");

  } catch (err) {
    console.error(err);
    container.innerHTML = "<p style='color:var(--danger);'>Gagal memuat lowongan.</p>";
  }
}

function daftar(link) {
  if (!link) return alert("Link belum tersedia.");
  window.open(link, "_blank");
}
window.initPage = initPage;
window.logout = logout;
window.goPengajuan = goPengajuan;
window.daftar = daftar;

</script>

</body>
</html>
